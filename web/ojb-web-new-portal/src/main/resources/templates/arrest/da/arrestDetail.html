<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
	<head>
		<title>Arrest Detail</title>
		<th:block th:include="fragments/general.html :: headerfiles"></th:block>
		<link rel="stylesheet" type="text/css" th:href="@{/webjars/datatables/1.10.19/css/dataTables.bootstrap4.min.css}" />
		<link rel="stylesheet" type="text/css" th:href="@{/webjars/font-awesome/5.2.0/css/all.css}" />
		<link href="https://cdn.jsdelivr.net/npm/gijgo@1.9.10/css/gijgo.min.css" rel="stylesheet" type="text/css" />
	</head>
	<body>
	    <!-- Begin page content -->
	    <div th:fragment="arrestDetail">
	       <div id="loadingAjaxPane" ></div>
	       
	       <div class="card card-primary">
					  <div class="card-header"><H5>ARREST DETAIL</H5></div>
					  <div class="card-body">
						     <p th:utext="${arrestDetailTransformed}" ></p>
			      </div>
   			 </div>
   			 <div id="modalDiv">
						<!-- The Modal -->
						<div class="modal" id="dispositionModal">
              <div id="modalIframeSpinner" ></div>
						  <div class="modal-dialog modal-lg">
						    <div class="modal-content">
						
						      <!-- Modal Header -->
						      <div class="modal-header">
						        <h4 class="modal-title">Add/Edit Disposition</h4>
						        <button type="button" class="close" data-dismiss="modal">&times;</button>
						      </div>
						
						      <!-- Modal body -->
						      <div class="modal-body">
						        <th:block th:include="arrest/da/dispositionForm::dispositionForm"></th:block>
						      </div>
					
						      <!-- Modal footer -->
						      <div class="modal-footer">
						        <button type="button" class="btn btn-primary" id="saveDisposition">Save</button>
	                  <button type="button" data-dismiss="modal" class="btn btn-secondary">Cancel</button>
						      </div>
						
			          </div>
					  </div>
				  </div>
			   </div>
		     <script th:inline="javascript">
		        /*<![CDATA[*/
				      var dispoCodeMapping = [[${daDispoCodeMapping}]]; 
				      var filedChargeCodeMapping = [[${daFiledChargeCodeMapping}]]; 
				      var amendedChargeCodeMapping = [[${daAmendedChargeCodeMapping}]]; 
				      var alternateSentenceMapping = [[${daAlternateSentenceMapping}]]; 
				      var reasonsForDismissalMapping = [[${daReasonsForDismissalMapping}]]; 
				      var chargeSeverityCodeMapping = [[${chargeSeverityCodeMapping}]]; 
			      /*]]>*/
         	   var dispoTables = [];
             $(function(){
            	   $('.date').mask('99/99/9999');
            	   $('.money').mask('000,000,000,000,000', {reverse: true});
            	   
            	   $('table.dispositionsTable').each(function(){
                	 dispoTables[$(this).attr('id')] = $(this).DataTable({
                		 dom: 'rt',
                		 order: [ 1, "desc" ],
                		 columnDefs: [ 
                        {
                            "targets": 0,
                            "searchable": false,
                            "orderable": false
                        }, 
                        {
                             "targets": [2],
                             "render": function ( data, type, row, meta ) {
                            	   if (dispoCodeMapping.hasOwnProperty(data)){
                            		   return dispoCodeMapping[data];
                            	   }
                            	   else{
	                                 return data;
                            	   }
                             }
                        },
                        {
                             "targets": [4],
                             "render": function ( data, type, row, meta ) {
                            	   if (filedChargeCodeMapping.hasOwnProperty(data)){
                            		   return filedChargeCodeMapping[data];
                            	   }
                            	   else{
	                                 return data;
                            	   }
                             }
                        },
                        {
                             "targets": [5],
                             "render": function ( data, type, row, meta ) {
                            	   if (amendedChargeCodeMapping.hasOwnProperty(data)){
                            		   return amendedChargeCodeMapping[data];
                            	   }
                            	   else{
	                                 return data;
                            	   }
                             }
                        },
                        {
                             "targets": [6],
                             "render": function ( data, type, row, meta ) {
                            	   if (chargeSeverityCodeMapping.hasOwnProperty(data)){
                            		   return chargeSeverityCodeMapping[data];
                            	   }
                            	   else{
	                                 return data;
                            	   }
                             }
                        },
                        {
                             "targets": [16],
                             "render": function ( data, type, row, meta ) {
                            	   if (alternateSentenceMapping.hasOwnProperty(data)){
                            		   return alternateSentenceMapping[data];
                            	   }
                            	   else{
	                                 return data;
                            	   }
                             }
                        },
                        {
                             "targets": [17],
                             "render": function ( data, type, row, meta ) {
                            	   if (reasonsForDismissalMapping.hasOwnProperty(data)){
                            		   return reasonsForDismissalMapping[data];
                            	   }
                            	   else{
	                                 return data;
                            	   }
                             }
                        },
                			  {
                		      "targets": [7, 8, 15],
                		      "render": $.fn.dataTable.render.number( ',', '.', 0, '$' )
                		    }
                		  ]/* , 
                		  scrollX: true,
             			    fixedColumns: {
             			        leftColumns: 3
             			    } */
                	 });
                 });
            	   
                 $('.dispositionsTable').on('click', 'a.addDisposition',function() {
                    var chargeId = $(this).closest("table").attr("id");
                    $("#arrestIdentification").val($('#searchResultsTable').attr('arrestId'));
                    $("#arrestChargeIdentification").val(chargeId);
                    $("#dispositionIdentification").val('');
                    $("#dispositionDate").val('');
                    $("#dispositionCode").val('');
                    $("#courtCaseNumber").val('');
                    $("#filedCharge").val('');
                    $("#amendedCharge").val('');
                    $("#fineAmount").val('');
                    $("#fineSuspended").val('');
                    $("#jailYears").val('');
                    $("#jailDays").val('');
                    $("#suspendedYears").val('');
                    $("#suspendedDays").val('');
                    $("#deferredYears").val('');
                    $("#deferredDays").val('');
                    $("#restitution").val('');
                    $("#alternateSentence").val('');
                    $("#reasonForDismissal").val('');
                    $("#provisionCode").val('');

                    console.log($("#dispositionForm").serialize());
                    xhr = $.get( context +"daArrests/dispositionForm", $("#dispositionForm").serialize(),  function(data) {
                    	$('.modal-body').html(data);
                      $('#dispositionModal').modal('show');
                    }).fail(ojbc.displayFailMessage);
                 }); 
                 
                 $('.dispositionsTable tbody').on('click', 'a.editDisposition',function() {
                	 var chargeId = $(this).closest("table").attr("id");
                	 $("#arrestIdentification").val($('#searchResultsTable').attr('arrestId'));
                	 $("#arrestChargeIdentification").val(chargeId);
                	 $("#dispositionIdentification").val($(this).closest("tr").attr("id"));
                	 console.log("chargeId:" + chargeId);
                	 var rowData = dispoTables[chargeId].row($(this).closest("tr")).data(); 
                	 console.log(rowData);
                	 console.log(rowData[4]);
                	 console.log(rowData[5]);
                	 $("#dispositionDate").val(rowData[1]);
                	 $("#dispositionCode").val(rowData[2]);
                	 $("#courtCaseNumber").val(rowData[3]);
                	 $("#filedCharge").val(rowData[4]);
                	 $("#amendedCharge").val(rowData[5]);
                	 $("#fineAmount").val(rowData[7].split('.', 1));
                	 $("#fineSuspended").val(rowData[8].split('.', 1));
                	 $("#jailYears").val(rowData[9]);
                	 $("#jailDays").val(rowData[10]);
                	 $("#suspendedYears").val(rowData[11]);
                	 $("#suspendedDays").val(rowData[12]);
                	 $("#deferredYears").val(rowData[13]);
                	 $("#deferredDays").val(rowData[14]);
                	 $("#restitution").val(rowData[15].split('.', 1));
                	 $("#alternateSentence").val(rowData[16]);
                	 $("#reasonForDismissal").val(rowData[17]);
                	 $("#provisionCode").val(rowData[18]);
                	 
                	 console.log($("#dispositionForm").serialize()+ "&amendedCharge=" + rowData[5]);
                   xhr = $.get( context +"daArrests/dispositionForm", 
                		  $("#dispositionForm").serialize() + "&amendedCharge=" + rowData[5] + "&suspendedYears=" + rowData[11] 
                          + "&deferredYears=" + rowData[13] +  "&deferredDays=" + rowData[14] + "&reasonForDismissal=" + rowData[17],  
                          function(data) {
                      $('.modal-body').html(data);
                      $('#dispositionModal').modal('show');
                   }).fail(ojbc.displayFailMessage);
                 });
                 
                 $('#saveDisposition').on('click', function(){
                	 var formData = $("#dispositionForm").serialize();
                	 
                	 var restitution = parseInt($("#restitution").val().replace(',', ''));
                	 var fineAmount = parseInt($("#fineAmount").val().replace(',', '')); 
               	   if ( restitution > 5000 || fineAmount > 1000){
               		   var confirmMessage = ""
               		   if (fineAmount > 1000) {
               			   confirmMessage += 'The Fine Amount exceeds $1,000. ' 
               		   }
               		   if (restitution > 1000) {
               			   confirmMessage += ' The Restitution exceeds $5,000. ' 
               		   }
               		   bootpopup.confirm(confirmMessage + "Please confirm to proceed.", "", function(ans) { if(ans){save(formData);} });  
               	   }
               	   else{
               		   save(formData);
               	   }
                 });

                 function save(formData){
                     xhr = $.post(context + "daArrests/saveDisposition",formData,function(data) {
                         console.log(formData);
                         
                         
                         if ($(data).find('div.card').length > 0){
                           $("#dispositionModal .close").click();
                           $('#portalContent').html(data); 
                         }
                         else{
                           $('.modal-body').html(data);
                           $('#dispositionModal').modal('show');
                         }
                       }).fail(ojbc.displayFailMessage);
                 }
                 
                 $('.dispositionsTable tbody').on('click', 'a.deleteDisposition',function() {
                   $("#arrestIdentification").val($('#searchResultsTable').attr('arrestId'));
                   $("#arrestChargeIdentification").val($(this).closest("table").attr("id"));
                   $("#dispositionIdentification").val($(this).closest("tr").attr("id"));
                   bootpopup.confirm("Please confirm that you want to delete this disposition" , "", 
                      function(ans) { 
                         if(ans){
                             xhr = $.post(context + "daArrests/dispositions/delete", $("#dispositionForm").serialize(), function(data) {
                                 $('#portalContent').html(data); 
                             }).fail(ojbc.displayFailMessage);
                         } 
                      }); 

                 });
            });
	      </script>
      </div>
      
	</body>
</html>
